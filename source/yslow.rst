Best Practices for Speeding Up Your Web Site
********************************************

本文翻译自Yahoo\ [#ref]_

最小化HTTP请求数
================
终端用户80%的响应时间花费在前端。其中花费最多的是下载页面中的各种组件：图片，样\
式表，JavaScript，Flash等。减少页面包含在页面中的组件可以减少客户端在渲染被请求\
页面时的HTTP的请求数。

减少页面组件数的一种方法是简化页面的设计。但是有没有一种方法可以建立包含大量组\
件的页面同时保持更快的响应时间呢？实际上在设计富页面时，有一些方法可以减少HTTP\
的请求次数：

1.  ``合并文件``\ 是一种减少HTTP请求数的方法。\ ``合并文件``\ 即：通过将所有的\
    脚本文件合并为一个脚本文件，同样将所有样式表文件合并为一个文件。当每个页面\
    载入的脚本和样式表不尽相同时，\ ``合并文件``\ 的方法面临着更大挑战，但是应\
    该了解到在发布过程时这是一种改善响应时间的手段。
2.  `CSS Sprites <http://alistapart.com/article/sprites>`_\ 是减少图片请求数的\
    有效方法。将背景图片组合为单个文件并使用CSS的\ ``background-image``\ 和\
    ``background-position``\ 等属性来控制背景图片显示，以期符合期望。
3.  `Image maps <http://www.w3.org/TR/html401/struct/objects.html#h-13.6>`_\ 将\
    多幅图片组合为一张，图片总的大小相同，但是减少了HTTP请求数加快了页面的加载\
    ，只有当图片在页面上处于连续位置时才可以使用\ ``Image maps``\ 方法。例如导\
    航栏。定义\ ``Image maps``\ 的坐标是相当乏味且容易出错，导航使用\ ``Image
    maps``\ 也无法访问，因此并不推荐使用。
4.  ``Inline images``\ 使用\ `data: URL scheme
    <http://tools.ietf.org/html/rfc2397>`_\ 将图片嵌入到页面，这会增大HTML文件\
    。将\ ``inline images``\ 合入到样式表（可缓存的）是一种减少HTTP请求数的方法\
    ，同时可以避免增加页面的大小。需要注意的是\ ``Inline images``\ 方法并不被所\
    有的主流浏览器支持。

减少页面的HTTP请求数是提高性能的第一步，对于改善首次访问的用户的体验是最为重要\
的准则。如Tenni Theurer博文\ `Browser Cache Usage - Exposed!
<http://yuiblog.com/blog/2007/01/04/performance-research-part-2/>`_\ 中描述的：\
网站每天的访问中有40%-60%用户是没有缓存任何数据的，首次访问时更快是更好的用户体\
验的关键。

使用CDN（内容分发网络）
=======================
用户距服务器的距离对\ ``响应时间``\ 有一定影响，因此将内容部署到多个分散的服务器
上将使得用户加载速度更快，但是该从什么地方开始呢？

作为第一步，将内容分散到不同地方的服务器，不必重新设计Web应用让其工作在分布式架\
构下。对于不同的应用，调整架构需要不同的工作量，甚至令人望而生畏。如同步会话状\
态，在不同位置的服务器间复制数据库等。这些都可能让你尝试减少用户与服务器间响应\
时间的努力功亏一篑，永远还要走到调整应用架构这一步。

请铭记：用户响应时间的80%-90%花费在下载页面中的各种组件：图片、样式表、脚本、动\
画等。这是\ *性能黄金准则(Performance Golden Rule)*\ 。与其从重新设计你的应用架\
构这类艰巨的任务开始，不如将你的静态文件分发到CDN，这不仅可以大大减少响应时间，\
而且CDN（的使用）非常简单。

CDN是一系列分散在各地WEB服务器，可以更加高效快捷的向用户提供服务。分发内容到某\
一用户时CDN所选择的服务器通常基于网络近似度，如最小的网络跳数，服务器的最快响应\
时间。

一些大的互联网公司拥有自己的CDN，但是也有一些CDN服务商提供付费服务，如Akamai
Technologies, EdgeCast, level3。对于初创公司和个人站点，CDN的价格可能难以承受，\
但是如果你的受众量不断增大，变得更加全球化，为了达到更快的响应，使用CDN是必须的\
。在Yahoo，将静态内容从各自的应用中剥离并使用CDN（前面提到的第三方CDN服务商和\
Yahoo自己的CDN），使用用户的响应时间提高了20%以上。切换到CDN只需要相对简单的修\
改，但是可以极大的提高网站访问速度。

添加\ ``Expires``\ 或\ ``Cache-Control``\ HTTP头
=================================================
此规则包含两个方面：

1.  对于静态内容，通过将HTTP头\ ``Expires``\ 设定为遥远的将来使其“永不过期”；
2.  对于动态内容，通过合理的设定HTTP头\ ``Cache-Control``\ 为浏览器设定一个请求\
    条件。

现在网页被设计得越来越丰富，这意味着页面中包含更多的脚本、样式表，图片，动画等。
用户第一次访问量不得不进行大量的HTTP请求，通过使用\ ``Expires``\ 头，可以让这些\
内容被客户端缓存，如此一来，用户接下来的访问就可以避免一些不必要的HTTP请求。\
``Expires``\ 头大量应用于图片资源，但是实际上它可以被应用于所有的页面内容，包括\
脚本，样式表，动画等。

浏览器（代理）使用缓存来减少HTTP请求数和大小，使用网页加载更快。WEB服务器通过在\
HTTP响应头中加入\ ``Expires``\ 头来告诉客户端（程序）当前内容可以缓存多久。下面\
是一个Expires时间设定较远的HTTP\ ``Expires``\ 头，它告诉浏览器直到2010年4月15号\
当前返回的内容都是有效的。\ ::

    Expires: Thu, 15 Apr 2010 20:00:00 GMT

如果你使用的是Apache，使用指令\ ``ExpiresDefault``\ 来设定一个相对当前的过期时\
间。下面的例子使用\ ``ExpiresDefault``\ 指令将过期时间设定为请求时间10年后。（\
译者注：\ ``Expires``\ 的设定值与WEB服务器时间有关，如果客户端与服务器时间不一\
致可能引起问题。详细请阅读\ :rfc:`2616`\ ）\ ::

    ExpiresDefault "access plus 10 years"

请注意：如果使用\ ``Expires``\ 将内容设置为永不过期，无论什么时间你对某内容进行\
了更新，都必须更换此资源的文件名。在Yahoo，我们通常在构建步骤中加入这样一步：将\
版本号加入到文件名中。例如：\ *yahoo_2.0.6.js*

只有用户已经访问过你的站点，使用包含一个“永不过期”的\ ``Expires``\ HTTP头才能影\
响页面访问量（PV, page views）。对于初次访问以及注意器缓存为空时，它不会影响（\
减少）HTTP请求数。\ **因此这种性能改进的影响有赖于用户有多大几率是在有缓存情形\
下访问站点。**\ 我们测量了Yahoo站点的这方面数据，发现大约有75%-85%有页面访问量\
是在有缓存情况下进行的。\ **通过使用“永不过期”的Expires头，可以增加被缓存的内容\
，当其它页面被访问时可以重复利用它们而不是向服务器再次请求**


压缩页面内容(Gzip Components)
=============================== 
通过前端工程师的调优，可以显著的减少HTTP请求和响应在网络上的传输时间。另一方面\
，用户的访问带宽速度，ISP，proximity to peering exchange points等都超出了开发团\
队的控制范围。但是这些都会影响到响应时间，压缩可以减小HTTP响应内容的大小进而减\
少响应时间。

从HTTP/1.1开始，WEB客户端在发起HTTP请求时，在请求头中添加字段\
``Accept-Encoding``\ 来说明客户端支持压缩：\ ::

    Accept-Encoding: gzip,deflate

当WEB服务器从请求头文件中发现了上面内容后，就会对响应内容使用一种由\
``Accept-Encoding``\ 指定的压缩方法进行压缩再返回给客户端。同样WEB服务器会在响应
头也会添加字段\ ``Accept-Encoding``\ 来告诉客户端返回内容使用了什么方法进行压缩
，如：\ ::

    Accept-Encoding: gzip

Gzip是由GNU项目开发的当前最为有效和流行压缩方法，在\ :rfc:`1952`\ 中进行了标准\
化，另一种可以看到的压缩方法是\ ``deflate``\ ，它并不那么的高效和流行。

经过Gzip压缩一般可以将响应内容大小减小70%，当前互联网上通过浏览器产生的流量的\
90%都声称支持gzip压缩。

对于浏览器和代理存在已知的问题：浏览器收到的内容的压缩格式和期望收到的格式不一\
致。幸运的是随着旧浏览器被淘汰，这种边际问题正逐渐减少。Apache的模块通过在响应\
头中自动添加适当的\ ``Vary``\ 值也可以消除这种问题。

WEB服务器基于文件类型来选择性进行压缩，决定压缩什么通常太有限。绝大多数WEB站点\
都会压缩HTML文件。另外对脚本、样式表进行压缩也是值得的，但是大多数站点都没有对\
它们进行压缩。事实上，任何文本内容包括XML，JSON都是值得压缩的。由于图片和PDF文\
件自身已经压缩过，所以它们都不需要压缩，如果对这些文件进行压缩，不仅浪费CPU，而\
且还可能增加文件大小。

使用gzip压缩多种文件类型，是一种减小页面大小和提高用户体验的一种简单方法。

将样式表放在页面顶部
====================
通过在Yahoo的(WEB)性能研究，我们发现将样式表放置在HTML文件的\ ``HEAD``\ 位置时\
，页面加载的更快。这是因为将样式表放在\ ``HEAD``\ 中允许页面逐步进行渲染。

关注性能的前端工程师想要页面是逐步加载，也就是说希望浏览器只要它获取到内容就可\
以进行渲染显示。这对于包含大量内容页面和网络较慢的用户特别重要。一些研究和\
`资料`_\ 显示，（在加载时）给用户以视觉的反馈提示（如进度条）是非常重要的。在我\
们的研究例子中，页面是逐步加载的，浏览器中页面内的头部，导航栏，顶部Logo等被逐\
步加载显示。所以为正在等待加载页面用户提供的视觉反馈，都可以改善所有用户的体验。

将样式表放在页面底部引起的问题是：大多数浏览器（包括IE）会禁止页面逐步渲染显示。
由于在这种情况下，浏览器无法确定上部元素的样式表是否会发生变化，所以为了避免页\
面元素的重复渲染，这些浏览器禁止此种情况下逐步渲染页面。

`HTML规范`_\ 明确指出样式表应该包含在页面的\ ``HEAD``\ ：“与标签\ ``a``\ 不同，\
``link``\ 只能出现在HTML文档的\ ``HEAD``\ 中，然而是可以存在多个\ ``link``\ 标签
。”对于空白页面或不包含样式表的内容，……最佳解决方案是遵循HTML规范，将你的样式表
放在页面的\ ``HEAD``\ 中进行加载。

.. _资料:   http://www.useit.com/papers/responsetime.html
.. _HTML规范:   http://www.w3.org/TR/html4/struct/links.html#h-12.3

将脚本放在页面的底部
====================
（加载）脚本会阻止浏览器的并行下载。\ `HTTP/1.1规范`_\ 中建议浏览器下载内容时每\
个域名并行下载最多为2个。如果你使用多个域名提供图片服务，可以实现超过两个的并行\
下载。当正在下载一个脚本时，即使资料在不同的服务器上，浏览器也不会进行任何其它\
下载。

在某些情形下，脚本不便于放置在页面的底部。例如，如果脚本中使用\
*document.write*\ 向页面中插入内容时就不能将它移动到页面底部。可能还有作用域的\
问题，在许多情况下，也有方法来解决这些问题。

另外一个常见的建议是使用延迟脚本（deferred scripts）。\ ``DEFER``\ 属性表示该脚\
本没有包含\ *document.write*\ 内容，暗示浏览器可以继续进行渲染。不幸的是，\
Firefox不支持\ ``DEFER``\ 属性。对于IE浏览器，脚本可能被延迟，但是并不像期望的\
那样（工作）。如果一个脚本可以被延迟，它就可以被移到页面的底部，这样就可以加快\
网页的加载速度了。

.. _HTTP/1.1规范: http://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.1.4


参考资料
=========
.. [#ref]   `Best Practices for Speeding Up Your Web Site <https://developer.yahoo.com/performance/rules.html>`_
